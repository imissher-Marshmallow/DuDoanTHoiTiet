<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Tr·ª£ L√Ω th√¥ng minh</title>
        <link rel="stylesheet" href="giaodien.css" />
        <!-- Li√™n k·∫øt ƒë·∫øn CSS chung -->
        <style>
            .container-wrapper {
                display: grid;
                grid-template-columns: 1fr 300px;
                gap: 2rem;
                max-width: 1000px;
                margin: 4rem auto;
                padding: 0 2rem;
            }

            .chat-container {
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid var(--glass-border);
                border-radius: 20px;
                box-shadow: var(--shadow);
                padding: 2rem;
                height: 500px;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .water-status-panel {
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid var(--glass-border);
                border-radius: 20px;
                box-shadow: var(--shadow);
                padding: 1.5rem;
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .status-item {
                border-bottom: 1px solid var(--glass-border);
                padding: 1rem 0;
            }

            .status-item:last-child {
                border-bottom: none;
            }

            .status-label {
                font-size: 0.85rem;
                color: var(--neutral-light);
                font-weight: 500;
            }

            .status-value {
                font-size: 1.4rem;
                color: var(--accent-color);
                font-weight: bold;
                margin-top: 0.3rem;
            }

            .status-value.normal {
                color: #4ade80;
            }

            .status-value.warning {
                color: #fbbf24;
            }

            .status-value.danger {
                color: #ef4444;
            }

            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .message {
                max-width: 90%;
                padding: 1rem;
                border-radius: 15px;
                position: relative;
                animation: fadeInUp 0.5s ease-out;
            }

            .user-message {
                background: linear-gradient(
                    45deg,
                    var(--accent-color),
                    #ffb347
                );
                color: black;
                align-self: flex-end;
            }

            .ai-message {
                background: var(--neutral-light);
                color: var(--neutral-dark);
                align-self: flex-start;
            }

            .chat-input {
                display: flex;
                gap: 1rem;
                padding-top: 1rem;
                border-top: 1px solid var(--glass-border);
            }

            .chat-input input {
                flex: 1;
                padding: 1rem;
                border: 1px solid var(--glass-border);
                border-radius: 25px;
                background: var(--glass-bg);
                color: var(--text-color);
                font-size: 1rem;
            }

            .chat-input button {
                padding: 1rem 2rem;
                background: linear-gradient(
                    45deg,
                    var(--primary-color),
                    var(--secondary-color)
                );
                color: black;
                border: none;
                border-radius: 25px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .chat-input button:hover {
                transform: scale(1.05);
                box-shadow: var(--shadow-hover);
            }

            @media (max-width: 768px) {
                .container-wrapper {
                    grid-template-columns: 1fr;
                }

                .chat-container {
                    height: 400px;
                }
            }

            .refresh-btn {
                padding: 0.5rem 1rem;
                background: var(--accent-color);
                color: black;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: 600;
            }

            .refresh-btn:hover {
                opacity: 0.9;
            }

            .loading {
                color: var(--neutral-light);
                font-size: 0.85rem;
            }
        </style>
    </head>
    <body>
        <header>
            <nav>
                <div class="logo">C·∫¢NH B√ÅO L≈® L·ª§T</div>
                <div class="nav-links">
                    <a href="index.html#home">Trang ch·ªß</a>
                    <a href="index.html#about">Gi·ªõi thi·ªáu</a>
                    <a href="index.html#vechungtoi">V·ªÅ Ch√∫ng T√¥i</a>
                    <div class="dropdown">
                        <span class="dropbtn">About‚¨á</span>
                        <div class="dropdown-content">
                            <a href="ai-assistant.html">Tr·ª£ l√Ω AI</a>
                            <a href="lienhe.html">Gi√∫p ƒë·ª°</a>
                            <a href="lienhe.html">B√°o l·ªói</a>
                        </div>
                    </div>
                    <a href="index.html#ranking">X·∫øp h·∫°ng</a>
                </div>
                <div class="auth-buttons">
                    <button class="login">ƒêƒÉng nh·∫≠p</button>
                    <button class="register">ƒêƒÉng k√Ω</button>
                    <button class="notification">Th√¥ng b√°oüîî</button>
                </div>
            </nav>
        </header>

        <div class="container-wrapper">
            <section class="chat-container">
                <h2 style="text-align: center; color: black; margin-bottom: 2rem">
                    Tr·ª£ L√Ω AI - H·ªèi ƒê√°p V·ªÅ L≈© L·ª•t
                </h2>
                <div class="chat-messages">
                    <div class="ai-message message">
                        Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI. B·∫°n c√≥ c√¢u h·ªèi g√¨ v·ªÅ c·∫£nh b√°o l≈©
                        l·ª•t? T√¥i c√≥ th·ªÉ tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ m·ª±c n∆∞·ªõc hi·ªán t·∫°i, d·ª± b√°o
                        10 ph√∫t t·ªõi, v√† xu h∆∞·ªõng n∆∞·ªõc.
                    </div>
                </div>
                <form class="chat-input">
                    <input type="text" placeholder="H·ªèi v·ªÅ m·ª±c n∆∞·ªõc, d·ª± b√°o, xu h∆∞·ªõng..." />
                    <button type="submit">G·ª≠i</button>
                </form>
            </section>

            <section class="water-status-panel">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: black;">üíß M·ª±c N∆∞·ªõc</h3>
                    <button class="refresh-btn" id="refreshBtn">C·∫≠p nh·∫≠t</button>
                </div>

                <div id="waterStatus">
                    <div class="loading">‚è≥ ƒêang t·∫£i...</div>
                </div>

                <div style="font-size: 0.75rem; color: var(--neutral-light); margin-top: 1rem;">
                    C·∫≠p nh·∫≠t m·ªói 5 gi√¢y
                </div>
            </section>
        </div>

        <footer>
            <p>&copy; 2025 H·ªçc T·∫≠p Online. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        </footer>

        <script>
            const form = document.querySelector(".chat-input");
            const input = form.querySelector("input");
            const messages = document.querySelector(".chat-messages");
            const statusPanel = document.getElementById("waterStatus");
            const refreshBtn = document.getElementById("refreshBtn");

            // ========================================
            // Fetch and display water status
            // ========================================
            async function updateWaterStatus() {
                try {
                    const response = await fetch("http://localhost:5000/api/water-status");
                    const data = await response.json();

                    let html = "";

                    // Current water level
                    if (data.sensor) {
                        const waterLevel = data.sensor.waterLevel;
                        let levelClass = "normal";
                        if (waterLevel > 200) levelClass = "danger";
                        else if (waterLevel > 150) levelClass = "warning";

                        html += `
                            <div class="status-item">
                                <div class="status-label">M·ª±c n∆∞·ªõc hi·ªán t·∫°i</div>
                                <div class="status-value ${levelClass}">${waterLevel.toFixed(
                            1
                        )} mm</div>
                            </div>
                        `;
                    }

                    // Forecast
                    if (data.forecast) {
                        const pred = data.forecast.pred_10min;
                        html += `
                            <div class="status-item">
                                <div class="status-label">D·ª± b√°o +10 ph√∫t</div>
                                <div class="status-value">${pred.toFixed(1)} mm</div>
                            </div>
                        `;
                    }

                    // History stats
                    if (data.history) {
                        html += `
                            <div class="status-item">
                                <div class="status-label">Min / Max</div>
                                <div class="status-value">${data.history.min.toFixed(
                            1
                        )} / ${data.history.max.toFixed(1)} mm</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Trung b√¨nh</div>
                                <div class="status-value">${data.history.avg.toFixed(
                            1
                        )} mm</div>
                            </div>
                        `;
                    }

                    statusPanel.innerHTML = html;
                } catch (error) {
                    statusPanel.innerHTML =
                        '<div class="loading">‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message + '</div>';
                }
            }

            // Update water status ONLY when user clicks refresh button
            // Do NOT load on page load
            
            refreshBtn.addEventListener("click", () => {
                console.log("User clicked refresh button");
                updateWaterStatus();
            });

            // ========================================
            // Chat functionality
            // ========================================
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                if (!input.value.trim()) return;

                // 1. Display user message
                const userMsg = document.createElement("div");
                userMsg.classList.add("message", "user-message");
                userMsg.textContent = input.value;
                messages.appendChild(userMsg);
                messages.scrollTop = messages.scrollHeight;

                // 2. Send to Flask backend
                try {
                    const response = await fetch("http://localhost:5000/chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message: input.value }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    // 3. Display AI response
                    const aiMsg = document.createElement("div");
                    aiMsg.classList.add("message", "ai-message");
                    if (data.reply) {
                        aiMsg.textContent = data.reply;
                    } else if (data.error) {
                        aiMsg.textContent = "L·ªói: " + data.error;
                    } else {
                        aiMsg.textContent = "L·ªói: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ AI.";
                    }
                    messages.appendChild(aiMsg);
                    messages.scrollTop = messages.scrollHeight;
                } catch (error) {
                    const errorMsg = document.createElement("div");
                    errorMsg.classList.add("message", "ai-message");
                    errorMsg.textContent = "‚ùå L·ªói k·∫øt n·ªëi: " + error.message + " (H√£y ch·∫Øc ch·∫Øn Flask ƒëang ch·∫°y tr√™n http://localhost:5000)";
                    messages.appendChild(errorMsg);
                    messages.scrollTop = messages.scrollHeight;
                    console.error("Chat error:", error);
                }

                input.value = "";
            });
        </script>
    </body>
</html>
